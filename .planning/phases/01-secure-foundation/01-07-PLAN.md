---
phase: 01-secure-foundation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified: 
  - src/lib/clawdbot.ts
  - src/cli/commands/generate.ts
  - src/lib/discovery.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "CLI discovers skills from nested skills directories"
    - "CLI extracts LLM model info from mcp.json or config files"
    - "CLI discovers CLIs from package.json bin entries"
    - "CLI extracts description from SOUL.md automatically"
    - "Skills count is accurate (not 0) for bots with skills"
  artifacts:
    - path: "src/lib/clawdbot.ts"
      provides: "Enhanced discovery logic"
      exports: ["ClawdBotDiscovery.discoverSkills()", "ClawdBotDiscovery.discoverLLM()", "ClawdBotDiscovery.discoverCLIs()"]
    - path: "src/cli/commands/generate.ts"
      provides: "Generate command with SOUL.md description extraction"
      contains: "extractDescriptionFromSoul() integration"
    - path: "src/lib/discovery.ts"
      provides: "Utility functions"
      exports: ["extractDescriptionFromSoul"]
  key_links:
    - from: "src/cli/commands/generate.ts:84-94"
      to: "src/lib/discovery.ts:185-201"
      via: "extractDescriptionFromSoul() call"
    - from: "src/lib/clawdbot.ts:25-31"
      to: "skills directories"
      via: "Recursive discovery with --skills-path support"
---

<objective>
Fix Gap 2: Bot Discovery Issues (Skills, LLM, CLIs, Description)

Purpose: The CLI currently shows Skills=0, missing LLM/CLIs, and doesn't extract description from SOUL.md. This makes bot profiles incomplete and inaccurate.

Output: Enhanced discovery logic that recursively finds skills, discovers LLM/CLIs from config files, and extracts description from SOUL.md
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/01-secure-foundation/01-secure-foundation-UAT.md

## Gap 2 Details (from UAT.md)
- **Truth**: Running `npx botarena generate <bot-path>` discovers bot configuration
- **Status**: Failed
- **User reported**: "it discovered the name but not skills (0) also it didnt ask the bot for its description, model, mcps clis"
- **Root cause**: 
  1. Skills discovery only checks hardcoded paths (src/lib/clawdbot.ts:25-31)
  2. LLM/CLIs hardcoded as 'Not specified' and [] (src/lib/clawdbot.ts:117-123)
  3. Description uses interactive prompt instead of SOUL.md extraction (src/cli/commands/generate.ts:84-94)
- **Missing**:
  - Recursive skills directory discovery or custom path flag
  - LLM model discovery from mcp.json, config files, or SOUL.md
  - CLI discovery from package.json bin entries or manifest
  - Integration of extractDescriptionFromSoul() into generate flow

## Current Code Locations
- src/lib/clawdbot.ts:25-31 - SKILL_DIRECTORIES hardcoded
- src/lib/clawdbot.ts:117-123 - LLM and CLIs hardcoded
- src/cli/commands/generate.ts:84-94 - Uses inquirer.prompt()
- src/lib/discovery.ts:185-201 - extractDescriptionFromSoul() exists but never called
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance skills discovery with recursive search</name>
  <files>src/lib/clawdbot.ts</files>
  <action>
    Modify src/lib/clawdbot.ts discoverSkills() method (lines 136-168):
    
    1. Add --skills-path flag support:
       - Accept optional skillsPath parameter in constructor
       - If provided, search that path recursively
       - If not provided, use SKILL_DIRECTORIES as fallback
    
    2. Implement recursive directory search:
       - When scanning skills directories, recursively search subdirectories
       - Look for skill.md, README.md, or package.json to identify skill roots
       - Extract skill name from directory name or package.json name field
    
    3. Update SKILL_DIRECTORIES to include common patterns:
       - Add 'src/skills', 'lib/skills', 'agents/skills'
       - Keep existing entries for backward compatibility
    
    4. Ensure discovered skills are unique (deduplicate by name)
    
    Lines to modify: 25-31 (SKILL_DIRECTORIES), 136-168 (discoverSkills method), 39-44 (constructor)
  </action>
  <verify>grep -A 20 "discoverSkills" src/lib/clawdbot.ts | grep -q "recursive\|skillsPath"</verify>
  <done>Skills discovery supports custom paths and recursive search</done>
</task>

<task type="auto">
  <name>Task 2: Add LLM and CLI discovery</name>
  <files>src/lib/clawdbot.ts</files>
  <action>
    Add new discovery methods to src/lib/clawdbot.ts:
    
    1. Add discoverLLM() method (after discoverMCPs around line 194):
       - Read mcp.json and look for model, llm, or provider fields
       - Check for config files: .clawdbot/config.json (safely), claude.config.json
       - Parse SOUL.md for LLM mentions (e.g., "Model: gpt-4", "LLM: claude-3")
       - Return { primary: string, fallbacks: string[] }
       - Default to "Not specified" only if nothing found
    
    2. Add discoverCLIs() method:
       - Read package.json and extract "bin" entries
       - Look for CLI manifests: cli.json, commands.json
       - Parse SOUL.md for CLI mentions
       - Return string[] of CLI names
    
    3. Update extractPublicConfig() (lines 108-130):
       - Call discoverLLM() and discoverCLIs() instead of hardcoded values
       - Keep fallback values only when discovery returns empty
    
    Lines to modify: 108-130 (extractPublicConfig), add new methods after line 194
  </action>
  <verify>grep -q "discoverLLM\|discoverCLIs" src/lib/clawdbot.ts</verify>
  <done>LLM and CLI discovery methods implemented and integrated</done>
</task>

<task type="auto">
  <name>Task 3: Integrate SOUL.md description extraction</name>
  <files>src/cli/commands/generate.ts</files>
  <action>
    Modify src/cli/commands/generate.ts to extract description from SOUL.md:
    
    1. Import extractDescriptionFromSoul from discovery.ts (add to imports at top)
    
    2. Update the description handling logic (lines 83-94):
       - BEFORE the interactive prompt, try to extract description from SOUL.md
       - Use discovery result to get SOUL.md content
       - Call extractDescriptionFromSoul(soulContent) to get auto-extracted description
       - If extracted description exists, use it as default for interactive mode
       - If no interactive mode and no user-provided description, use extracted description
       - Only fall back to 'A helpful AI assistant' if nothing else available
    
    3. Update the flow:
       ```typescript
       // After discovery, before interactive prompt
       let autoDescription = '';
       const soulFile = discovered.files.find(f => f.path === 'SOUL.md');
       if (soulFile) {
         autoDescription = extractDescriptionFromSoul(soulFile.content) || '';
       }
       
       // Use autoDescription as default or fallback
       let userDescription = autoDescription;
       if (flags.interactive) {
         // Prompt with autoDescription as default
       }
       ```
    
    Lines to modify: 1-10 (imports), 83-94 (description logic)
  </action>
  <verify>grep -q "extractDescriptionFromSoul" src/cli/commands/generate.ts</verify>
  <done>SOUL.md description extraction integrated into generate flow</done>
</task>

</tasks>

<verification>
- [ ] Skills discovery recursively searches directories
- [ ] --skills-path flag supported (or documented)
- [ ] LLM discovery reads from mcp.json and config files
- [ ] CLI discovery reads from package.json bin entries
- [ ] Description extracted from SOUL.md automatically
- [ ] All discovery methods have unit test coverage (if tests exist)
</verification>

<success_criteria>
Running `npx botarena generate <bot-path>` on a bot with:
- Skills in nested directories → shows correct skill count (>0)
- LLM configured in mcp.json → shows correct model
- CLIs in package.json bin → shows CLI list
- Description in SOUL.md → extracts and displays it
</success_criteria>

<output>
After completion, create `.planning/phases/01-secure-foundation/01-07-SUMMARY.md`
</output>
